version: "3.7"

services:
  web:
    image: mempool/mempool-frontend:latest
    container_name: mempool-web
    environment:
      FRONTEND_HTTP_PORT: 8080
      BACKEND_MAINNET_HTTP_HOST: api
    # volumes:
    # secrets:
    # networks:
    ports:
      - 80:8080
    depends_on:
      db:
        condition: service_healthy
    restart: on-failure
    init: true
    user: "1000:1000"
    stop_grace_period: 1m

  api:
    image: mempool/mempool-backend:latest
    container_name: mempool-api
    env_file: api.env
    volumes:
      - api-data:/backend/cache:rw
    # secrets:
    # networks:
    # ports:
    depends_on:
      db:
        condition: service_healthy
    restart: on-failure
    init: true
    user: "1000:1000"
    post_start:
      - command: ["chown", "-R", "1000:1000", "/backend/cache"]
        user: "root"
    stop_grace_period: 1m

  db:
    image: mariadb:10.5.21
    container_name: mempool-db
    environment:
      MYSQL_DATABASE: mempool
      MYSQL_USER: mempool
      MYSQL_PASSWORD: mempool
      MYSQL_ROOT_PASSWORD: admin
    volumes:
      - db-data:/var/lib/mysql:rw
    # secrets:
    # networks:
    # ports:
    # depends_on:
    restart: on-failure
    init: true
    user: "1000:1000"
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-padmin"]
    post_start:
      - command: ["chown", "-R", "1000:1000", "/var/lib/mysql"]
        user: "root"
    stop_grace_period: 1m

volumes:
  db-data:
  api-data: