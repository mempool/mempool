<div class="rbf-timeline box" [class.mined]="replacements.mined">
  <div class="timeline-wrapper">
    <div class="timeline" *ngFor="let timeline of rows; let j = index">
      <div class="intervals" *ngIf="j < rowLimit || timelineExpanded">
        <ng-container *ngFor="let cell of timeline; let i = index;">
          <div class="node-spacer"></div>
          <ng-container *ngIf="i < timeline.length - 1">
            <div class="interval" *ngIf="cell.replacement?.interval != null; else intervalSpacer">
              <div class="interval-time">
                <app-time [time]="cell.replacement.interval" [relative]="false"></app-time>
              </div>
            </div>
          </ng-container>
        </ng-container>
      </div>
      <div class="nodes" *ngIf="j < rowLimit || timelineExpanded">
        <ng-container *ngFor="let cell of timeline; let i = index;">
          <ng-container *ngIf="cell.replacement?.tx; else nonNode">
            <div class="node"
              [id]="'node-'+cell.replacement.tx.txid"
              [class.selected]="txid === cell.replacement.tx.txid"
              [class.mined]="cell.replacement.tx.mined"
              [class.first-node]="cell.first"
            >
              <div class="track left" [class.fullrbf]="cell.replacement?.tx?.fullRbf"></div>
              <div class="track right" [class.fullrbf]="cell.fullRbf"></div>
              <a class="shape-border"
                [class.rbf]="cell.replacement.tx.rbf"
                [routerLink]="['/tx/' | relativeUrl, cell.replacement.tx.txid]"
                (pointerover)="onHover($event, cell.replacement);"
                (pointerout)="onBlur($event);"
              >
                <div class="shape"></div>
              </a>
              <span class="fee-rate"><app-fee-rate [fee]="cell.replacement.tx.fee" [weight]="cell.replacement.tx.vsize * 4" [unitStyle]="{ display: 'block', marginTop: '-0.5em'}"></app-fee-rate></span>
            </div>
          </ng-container>
          <ng-template #nonNode>
            <ng-container [ngSwitch]="cell.connector">
              <div class="connector" [class.fullrbf]="cell.fullRbf" *ngSwitchCase="'pipe'"><div class="pipe" [class.fullrbf]="cell.fullRbf" [class.last-pipe]="!timelineExpanded && j === rowLimit - 1"></div></div>
              <div class="connector" *ngSwitchCase="'corner'"><div class="corner" [class.fullrbf]="cell.fullRbf"></div></div>
              <div class="node-spacer" *ngSwitchDefault></div>
            </ng-container>
          </ng-template>
          <ng-container *ngIf="i < timeline.length - 1">
            <div class="interval-spacer" *ngIf="cell.replacement?.interval != null; else intervalSpacer">
              <div class="track" [class.fullrbf]="cell.fullRbf"></div>
            </div>
          </ng-container>
        </ng-container>
      </div>
    </div>
  </div>
  <div [class.fade-out]="!timelineExpanded && rows.length > rowLimit"></div>
  <div class="toggle-wrapper" *ngIf="rows.length > rowLimit && rowLimit !== 0">
    <button class="btn btn-sm btn-primary graph-toggle" (click)="toggleTimeline(true);" *ngIf="!timelineExpanded; else collapseBtn">
      <span i18n="show-all">Show all</span>
      (<ng-container *ngTemplateOutlet="xRemaining; context: {$implicit: rows.length - rowLimit}"></ng-container>)
    </button>
    <ng-template #collapseBtn>
      <button class="btn btn-sm btn-primary graph-toggle" (click)="toggleTimeline(false);"><span i18n="show-less">Show less</span></button>
    </ng-template>
  </div>

  <!-- RBF Structural Diff Button -->
  <div class="diff-button-wrapper" *ngIf="getPredecessorTxid()">
    <button class="btn btn-sm btn-secondary diff-toggle" (click)="toggleStructuralDiff();">
      <i class="bi bi-code-slash"></i>
      <span *ngIf="!showDiff" i18n="rbf-diff-show">Show structural diff</span>
      <span *ngIf="showDiff" i18n="rbf-diff-hide">Hide structural diff</span>
    </button>
  </div>

<!-- RBF Structural Diff Content -->
<div class="rbf-diff-section" *ngIf="showDiff && comparisonData">
  <div class="row">
    <!-- Left Column: Previous Transaction -->
    <div class="col-sm">
      <table class="table table-borderless table-striped">
        <tbody>
          <tr class="diff-head previous">
            <td colspan="2">
              <span i18n="rbf-diff.previous-tx">Previous Transaction</span>
            </td>
          </tr>
          <tr class="diff-txid">
            <td colspan="2">
              <code>{{ selectedOldTx.txid.substring(0, 12) }}...{{ selectedOldTx.txid.substring(selectedOldTx.txid.length - 8) }}</code>
            </td>
          </tr>

          <ng-container *ngTemplateOutlet="previousDetails"></ng-container>
        </tbody>
      </table>
    </div>

    <!-- Right Column: Current Transaction -->
    <div class="col-sm">
      <table class="table table-borderless table-striped">
        <tbody>
          <tr class="diff-head current">
            <td colspan="2">
              <span i18n="rbf-diff.current-tx">Current Transaction</span>
            </td>
          </tr>
          <tr class="diff-txid">
            <td colspan="2">
              <code>{{ selectedNewTx.txid.substring(0, 12) }}...{{ selectedNewTx.txid.substring(selectedNewTx.txid.length - 8) }}</code>
            </td>
          </tr>

          <ng-container *ngTemplateOutlet="currentDetails"></ng-container>
        </tbody>
      </table>
    </div>
  </div>
</div>

  <!-- Previous Transaction Table -->
  <ng-template #previousDetails>
        <!-- Metadata Section -->
        <ng-container *ngIf="comparisonData.metadata.hasChanges">
          <ng-container *ngFor="let row of comparisonData.metadata.rows">
            <tr>
              <td [attr.i18n]="row.i18nKey">{{ row.label }}</td>
              <td>{{ row.previous }}</td>
            </tr>
          </ng-container>
        </ng-container>

        <!-- Metrics Section -->
        <ng-container *ngIf="comparisonData.metrics.hasChanges">
          <ng-container *ngFor="let row of comparisonData.metrics.rows">
            <tr>
              <td [attr.i18n]="row.i18nKey">{{ row.label }}</td>
              <td>
                <ng-container *ngIf="row.isAmount">
                  <app-amount [satoshis]="asNumber(row.previous)" digitsInfo="1.2-2" [noFiat]="true"></app-amount>
                </ng-container>
                <ng-container *ngIf="!row.isAmount">
                  <span [innerHTML]="'&lrm;' + (row.previous | number) + ' ' + row.unit"></span>
                </ng-container>
              </td>
            </tr>
          </ng-container>
        </ng-container>

        <!-- Inputs Section -->
        <ng-container *ngIf="comparisonData.inputs.hasChanges">
          <ng-container *ngFor="let row of comparisonData.inputs.rows">
            <tr>
              <td [attr.i18n]="row.i18nKey">{{ row.label }}</td>
              <td>
                <span *ngIf="row.previous !== null">{{ row.previous }}</span>
                <span *ngIf="row.previous === null" class="text-muted">—</span>
              </td>
            </tr>
          </ng-container>
        </ng-container>

        <!-- Outputs Section -->
        <ng-container *ngIf="comparisonData.outputs.hasChanges">
          <ng-container *ngFor="let row of comparisonData.outputs.rows">
            <tr>
              <td [attr.i18n]="row.i18nKey">{{ row.label }}</td>
              <td>
                <span *ngIf="row.previous !== null">{{ row.previous }}</span>
                <span *ngIf="row.previous === null" class="text-muted">—</span>
              </td>
            </tr>
          </ng-container>
        </ng-container>


  </ng-template>

  <!-- Current Transaction Table -->
  <ng-template #currentDetails>
        <!-- Metadata Section -->
        <ng-container *ngIf="comparisonData.metadata.hasChanges">
          <ng-container *ngFor="let row of comparisonData.metadata.rows">
            <tr>
              <td [attr.i18n]="row.i18nKey">{{ row.label }}</td>
              <td>
                {{ row.current }}
                <span class="changed-indicator">●</span>
              </td>
            </tr>
          </ng-container>
        </ng-container>

        <!-- Metrics Section -->
        <ng-container *ngIf="comparisonData.metrics.hasChanges">
          <ng-container *ngFor="let row of comparisonData.metrics.rows">
            <tr>
              <td [attr.i18n]="row.i18nKey">{{ row.label }}</td>
              <td>
                <ng-container *ngIf="row.isAmount">
                  <app-amount [satoshis]="asNumber(row.current)" digitsInfo="1.2-2" [noFiat]="true"></app-amount>
                </ng-container>
                <ng-container *ngIf="!row.isAmount">
                  <span [innerHTML]="'&lrm;' + (row.current | number) + ' ' + row.unit"></span>
                </ng-container>
                <span *ngIf="row.percentage !== null" class="difference" [class.positive]="row.changeType === 'positive'" [class.negative]="row.changeType === 'negative'">
                  {{ row.percentage > 0 ? '+' : '' }}{{ row.percentage | number: '1.0-1' }}%
                </span>
              </td>
            </tr>
          </ng-container>
        </ng-container>

        <!-- Inputs Section -->
        <ng-container *ngIf="comparisonData.inputs.hasChanges">
          <ng-container *ngFor="let row of comparisonData.inputs.rows">
            <tr>
              <td [attr.i18n]="row.i18nKey">{{ row.label }}</td>
              <td>
                <span *ngIf="row.current !== null">{{ row.current }}</span>
                <span *ngIf="row.current === null" class="text-muted">—</span>
              </td>
            </tr>
          </ng-container>
        </ng-container>

        <!-- Outputs Section -->
        <ng-container *ngIf="comparisonData.outputs.hasChanges">
          <ng-container *ngFor="let row of comparisonData.outputs.rows">
            <tr>
              <td [attr.i18n]="row.i18nKey">{{ row.label }}</td>
              <td>
                <span *ngIf="row.current !== null">{{ row.current }}</span>
                <span *ngIf="row.current === null" class="text-muted">—</span>
              </td>
            </tr>
          </ng-container>
        </ng-container>
  </ng-template>

  <ng-template #nodeSpacer>
    <div class="node-spacer"></div>
  </ng-template>

  <ng-template #intervalSpacer>
    <div class="interval-spacer"></div>
  </ng-template>

  <app-rbf-timeline-tooltip
    [rbfInfo]="hoverInfo"
    [cursorPosition]="tooltipPosition"
  ></app-rbf-timeline-tooltip>

  <!-- <app-rbf-timeline-tooltip
    *ngIf=[tooltip]
    [line]="hoverLine"
    [cursorPosition]="tooltipPosition"
    [isConnector]="hoverConnector"
  ></app-rbf-timeline-tooltip> -->
</div>

<ng-template #xRemaining let-x i18n="x-remaining">{{ x }} remaining</ng-template>